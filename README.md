# Pipeline-for-SKA-Observations-of-MS0735
A pipeline to simulate Square Kilometer Array Sunyaev Zel'dovich observations of the AGN cavities of galaxy cluster MS0735. 

A brief idea of the process: 1) make a model map of the SZ signal being recieved from the cluster, 2) run the SKA simulation using 'Profile' software (Grainge et al., 2002), 3) based on the output uv FITS files, create an input file of the model to use in McAdam where we will run Bayesian inference — specifically nested sampling via MultiNest (Feroz and Hobson 2008, Feroz et al. 2009, Feroz et al. 2019.) for parameter estimate and model comparison.

## Creating a simulated SZ signal map of cluster MS0735
The purpose of this investigation is to observe the galaxy cluster cavities which are produced by the AGN jets, and are described by the suppression factor 'f' defined in Abdulla et al. (2019). For an in-depth description of the calculations behind the creation of a simulated y-map and subsequent signal map of a galaxy cluster, see section 4.2.1 of the Master's thesis which can be found here [Sophia Geris Master's Thesis](https://vuw-my.sharepoint.com/:b:/g/personal/gerisso_staff_vuw_ac_nz1/Ed5ZLI0h3r1DmTRMXnmXU3wBA6ukzjePt2zDtwWFgKZh9g?e=fAg5I5). This process is carried out using the Python script **Create_SZ_signal_map_for_MS0735.py** which can be adapted for thermal or non-thermal cavities in the cluster. The file **ymap_template.fits** is a template used to store the output of the signal map code ready for use in a Profile simulation. 

## Simulating SKA observations with Profile
When the model signal map of the cluster has been created, the output FITS file can be used to simulate an interferometric observation by the Square Kilometer Array using the Profile software. For a brief description of how Profile simulates an interferometric observation see section 4.2.2 of [Sophia Geris Master's Thesis](https://vuw-my.sharepoint.com/:b:/g/personal/gerisso_staff_vuw_ac_nz1/Ed5ZLI0h3r1DmTRMXnmXU3wBA6ukzjePt2zDtwWFgKZh9g?e=fAg5I5). 

Simulations were run on the Victoria University of Wellington HPC, Rāpoi. To run the Profile software, a list of commands is needed to specify the parameters used for the observation. If Profile is run interactively then the commands can be manually entered. However, to run Profile as a batch job, the commands should be saved in a file to use as input for the simulation. **example_profile_commands.sh** is an example file of Profile commands used to simulate an 8 hour SKA observation of the model galaxy cluster MS0735 created with **Create_SZ_signal_map_for_MS0735.py**. If multiple simulations of the same observation are required, the list of commands can be copied the required number of times using the bash script **copy** which also changes the output FITS file name for each copy.

To run the multiple simulations, the batch submit script **sequential.sh** can be used. This runs profile using the different files of commands, sequentially rather than all at once (this avoids the same noise being added for each observation, if multiple observations of the same cluster from the same fits file are wanted to be simulated). This takes files of commands with either 'thermal' or 'non-thermal' in their name but this condition can be adjusted depending on which files of commands need to be used. The result of running Profile will be Fits files containing the uv data of the observation.

## Preparing data for Bayesian inference
The FITS file of uv data that is output from the Profile simulation needs to be prepared for Bayesian inference for model comparison and parameter estimation can be performed. The uv data must first be binned. The bash script **Binning_uv_fits_files** will bin the data and output the binned FITS file into a specified folder. This script uses the Python script **uvsep.py** in the folder python_scripts_5. Next, the cluster model for the McAdam software (Feroz et al., 2009) (which is used to perform Bayesian inference via MultiNest) must be prepared. The input file for McAdam is a .mcini file which specifies the model. The template that is used to build the model on is called **template.mcini**. To specify the parameters that need to be added to the template to create the model cluster, the Python script **mcadam_setup.py** in folder python_scripts_5 needs to be used. The bash script **making_mcadam_models_redshift.txt** will run this Python script for each binned FITS file and will enter a specified list of commands that the Python script asks for to construct the model (by entering the specified parameters in the template.mcini file). These commands can be adjusted for the cluster that is needed to be modelled and includes things like specifying redshift, priors on the suppression factor and y_tot (see the output of the Python script **mcadam_setup.py** to see what parameters are being asked for). It then creates a 'chains' directory where the output of McAdam will go, and produces the input file that has the specified model parameters in it. Parameters in the template.mcini file can also be changed manually before running **making_mcadam_models_redshift.txt** which will make input files with that parameter the same for all binned FITS files. To add more parameters that can be specified using **making_mcadam_models_redshift.txt**, the files **mcadam_setup.py**, **include_file.py** and **template.mcini** (in the python_scripts_5 directory) will need to be edited, e.g. if you want to be able to input a certain parameter automatically into the .mcini file then copy what has been done in these three files to allow the suppression factor priors to be input with **making_mcadam_models_redshift.txt**.

## References
Z. Abdulla, J. E. Carlstrom, A. B. Mantz, D. P. Marrone, C. H. Greer, J. W. Lamb, E. M. Leitch, S. Muchovej, C. O’Donnell, T. J. Plagge, and D. Woody. Constraints on the Thermal Contents of the X-Ray Cavities of Cluster MS 0735.6+7421 with Sunyaev- Zel’dovich Effect Observations. The Astrophysical Journal, 871(2):195, 2019.

F. Feroz and M. P. Hobson. Multimodal nested sampling: an efficient and robust alter- native to markov chain monte carlo methods for astronomical data analyses. Monthly Notices of the Royal Astronomical Society, 384(2):449–463, 2008.

F. Feroz, M. P. Hobson, E. Cameron, and A. N. Pettitt. Importance nested sampling and the MultiNest algorithm. The Open Journal of Astrophysics, 2(1), 2019.

F. Feroz, M. P. Hobson, and M. Bridges. MultiNest: an efficient and robust bayesian inference tool for cosmology and particle physics. Monthly Notices of the Royal Astro- nomical Society, 398(4):1601–1614, 2009.

F. Feroz, M. P. Hobson, J. T. L. Zwart, R. D. E. Saunders, and K. J. B. Grainge. Bayesian modelling of clusters of galaxies from multifrequency-pointed Sunyaev-Zel’dovich observations. Monthly Notices of the Royal Astronomical Society, 398(4):2049–2060, 2009.

K. Grainge, M. E. Jones, G. Pooley, R. Saunders, A. Edge, W. F. Grainger, and R. Kneissl. Measuring the Hubble constant from Ryle Telescope and X-ray observations, with application to Abell 1413. Monthly Notices of the Royal Astronomical Society, 333(2): 318–326, June 2002.
